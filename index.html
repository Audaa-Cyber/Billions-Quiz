<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billions Network Identity Quiz</title>
    
<script src="https://cdn.tailwindcss.com"></script>
    
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* Custom styles for the dark theme and font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        
        :root {
            --bg-dark: #0a0a0a;
            --card-dark: #1e1e1e;
            --card-hover: #27272a;
            --text-main: #ffffff;
            --text-sub: #a1a1aa;
            
            --gradient-start: #22d3ee; /* Bright Cyan */
            --gradient-middle: #3b82f6; /* Blue-500 */
            --gradient-end: #8b5cf6;   /* Violet-500 */
            
            --title-start: #22d3ee;
            --title-end: #22d3ee;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid rgba(139, 92, 246, 0.1); 
            box-shadow: 0 0 50px rgba(59, 130, 246, 0.1);
        }

        #app-container {
            width: 100%; 
            max-width: 480px;
            min-width: 320px;
            background-color: var(--bg-dark); 
        }

        .title-glow {
            text-shadow: 0 0 20px rgba(34, 211, 238, 0.6); 
            background: linear-gradient(to right, var(--title-start), var(--title-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .bg-active-gradient {
            background: linear-gradient(to bottom right, var(--gradient-start), var(--gradient-middle));
            color: white; 
            border: none;
            font-weight: 800;
            box-shadow: 0 0 15px rgba(34, 211, 238, 0.4); 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .bg-active-gradient:hover {
            opacity: 0.95;
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.6);
        }

        .bg-inactive {
            background-color: var(--card-dark);
            color: var(--text-sub);
            border: 1px solid #27272a; 
            transition: all 0.2s ease;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); 
        }
        .bg-inactive:hover {
            background-color: var(--card-hover);
            color: white;
            border-color: #52525b; 
        }
        .bg-inactive .text-sm {
             color: #a1a1aa; 
             opacity: 0.6;
        }
        
        .input-field {
            background-color: var(--card-dark);
            border: 1px solid #27272a;
            color: var(--text-main);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--gradient-start);
            box-shadow: 0 0 5px rgba(34, 211, 238, 0.4); 
        }

        /* Styling for the new Quiz Screen layout */
        .quiz-stat-box {
            background-color: #1a1a1a;
            border: 1px solid #333;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            transition: background-color 0.2s;
        }
        
        .answer-button {
            background-color: #262626; /* Darker option background */
            color: #ccc;
            border: 1px solid #3f3f46; /* Border */
            transition: all 0.2s ease;
        }
        .answer-button:hover:not(:disabled) {
            background-color: #3f3f46;
            color: #fff;
            border-color: #71717a;
        }

        /* Timer Bar as a visual progress indicator */
        .timer-bar-container-top {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, #4b5563, #3f3f46); /* Dark base for the bar */
            overflow: hidden;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
        }
        
        .timer-bar {
            height: 100%;
            /* Progress bar color gradient */
            background: linear-gradient(to right, #22d3ee, #8b5cf6); 
            /* Transition is set dynamically in JS to match question time */
        }

        /* Styles for the new Result Screen layout */
        .results-card {
            background-color: #171717;
            border: 1px solid #2c2c2c;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.6);
            /* Important for html2canvas to capture correctly */
            transform: translateZ(0);
            border-radius: 2rem; /* Adjusted for more curve */
        }
        .result-stat-box {
            background-color: rgba(40, 40, 40, 0.7); /* Slightly lighter dark */
            border: 1px solid #3a3a3a;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        /* Changed gradient to blue and cyan blue */
        .text-gradient-cyan-blue {
            background: linear-gradient(to right, #0ea5e9, #22d3ee); /* Blue to Cyan */
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* New style for selected difficulty on leaderboard filter */
        .leaderboard-filter-btn {
            background-color: #262626; 
            color: #94a3b8; /* slate-400 */
            border: 1px solid #3f3f46;
            transition: all 0.2s;
        }
        .leaderboard-filter-btn.active {
            background: linear-gradient(to right, #0ea5e9, #22d3ee); /* Blue to Cyan */
            color: white;
            font-weight: 700;
            border-color: #22d3ee;
        }

        /* !!! NEW CSS FOR SCREENSHOT FIX !!! */
        /* These classes help ensure html2canvas captures the intended background and border-radius */
        .screenshot-container-padding {
            padding: 0 !important; /* Remove padding for screenshot context */
        }
        .screenshot-wrapper-padded {
            padding: 1rem; /* The 'gap' around the card */
            background-color: var(--bg-dark) !important; /* Ensure dark background */
            border-radius: 2.5rem !important; /* Larger radius for the wrapper to contain the card */
            box-shadow: 0 0 0px 5px rgba(139, 92, 246, 0.1) !important; /* Subtle outer border for visual interest */
        }
        /* Temporary classes for html2canvas text rendering fix */
        .h2c-text-gradient-fix {
            color: #22d3ee !important; /* Solid color for screenshot */
            background: none !important;
            -webkit-background-clip: unset !important;
            -webkit-text-fill-color: unset !important;
        }
        .h2c-percentage-gradient-fix {
            color: #0ea5e9 !important; /* Solid color for screenshot */
            background: none !important;
            -webkit-background-clip: unset !important;
            -webkit-text-fill-color: unset !important;
        }
        .h2c-blue-glow-fix {
            background: #3b82f6 !important; /* Solid blue for the glow effect */
            filter: blur(25px) !important; /* Maintain a blur effect */
            opacity: 0.7 !important; /* Maintain some transparency */
        }
    </style>
</head>
<body class="p-4">

    
<div id="app-container" class="w-full max-w-md p-6 sm:p-8 rounded-2xl">

        
<div id="quiz-settings-screen" class="flex flex-col items-center w-full">
            
            <h1 class="text-4xl font-black mb-0 uppercase tracking-wider text-center flex justify-center items-center">
                <span class="title-glow">BILLIONS</span>
                <span class="title-glow ml-2">NETWORK</span>
            </h1>
            <p class="text-sm text-gray-400 mb-8 text-center tracking-wider">Identity & Verification Quiz</p>
            
            
<div class="w-full mb-8">
                <label for="user-name-input" class="block text-sm font-bold text-gray-400 uppercase tracking-widest mb-2 text-center">Your Name</label>
                <input type="text" id="user-name-input" placeholder="e.g., Jane Doe" class="w-full input-field text-center">
            </div>

            
<div class="w-full mb-8">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-3 text-center">DIFFICULTY LEVEL (Q Count & Time)</h3>
                <div class="grid grid-cols-3 gap-3">
                    
<button onclick="selectDifficulty('easy')" id="btn-diff-easy" class="diff-btn relative rounded-xl p-3 flex flex-col items-center justify-center transition-all duration-200 bg-inactive h-24">
                        <span class="text-base font-bold mb-1">Easy (6Q)</span>
                        <span class="time-display text-[10px] opacity-60 leading-tight text-center">12 seconds<br>per question</span>
                    </button>
                    
<button onclick="selectDifficulty('medium')" id="btn-diff-medium" class="diff-btn relative rounded-xl p-3 flex flex-col items-center justify-center transition-all duration-200 bg-inactive h-24">
                        <span class="text-base font-bold mb-1">Medium (6Q)</span>
                        <span class="time-display text-[10px] opacity: 0.60; leading-tight text-center">8 seconds<br>per question</span>
                    </button>
                    
<button onclick="selectDifficulty('hard')" id="btn-diff-hard" class="diff-btn relative rounded-xl p-3 flex flex-col items-center justify-center transition-all duration-200 bg-inactive h-24">
                        <span class="text-base font-bold mb-1">Hard (8Q)</span>
                        <span class="time-display text-[10px] opacity-60 leading-tight text-center">4 seconds<br>per question</span>
                    </button>
                </div>
            </div>

            
<button onclick="startGame()" class="w-full sm:w-1/2 py-4 rounded-xl font-bold text-lg bg-active-gradient text-[#0a0a0a] shadow-[0_0_20px_rgba(34,211,238,0.5)] hover:scale-[1.03] transition-transform duration-200 mb-6">
                Begin Quiz
            </button>

            <p id="error-msg" class="text-red-500 text-xs mt-0 mb-4 h-4"></p>

            
<div class="w-full">
                <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-3 text-center border-t pt-4 border-zinc-800">GLOBAL LEADERBOARD (<span id="leaderboard-title-diff">Easy</span>)</h3>
                
                <div class="flex justify-center gap-2 mb-4">
                    <button class="leaderboard-filter-btn rounded-full px-4 py-1 text-xs" data-filter="easy" onclick="filterLeaderboard('easy')">Easy</button>
                    <button class="leaderboard-filter-btn rounded-full px-4 py-1 text-xs" data-filter="medium" onclick="filterLeaderboard('medium')">Medium</button>
                    <button class="leaderboard-filter-btn rounded-full px-4 py-1 text-xs" data-filter="hard" onclick="filterLeaderboard('hard')">Hard</button>
                </div>

                <div id="leaderboard-container" class="w-full bg-[#121212] p-4 rounded-xl shadow-inner border border-zinc-800">
                    <p id="leaderboard-status" class="text-center text-sm text-gray-500">Loading scores...</p>
                    <ul id="leaderboard-list" class="space-y-2">
                        
</ul>
                </div>
            </div>

        </div>


        
<div id="quiz-content" class="hidden flex-col w-full bg-[#171717] p-6 rounded-2xl border border-zinc-800 shadow-2xl relative overflow-hidden">
            
            
<div class="timer-bar-container-top">
                <div id="timer-bar" class="timer-bar w-full"></div>
            </div>
            
            
<div class="text-center text-sm font-bold text-gray-300 uppercase tracking-widest mt-4 mb-4" id="player-name-display">
                PLAYER
            </div>

            <div class="grid grid-cols-3 gap-3 mb-6">
                
<div class="quiz-stat-box rounded-lg p-2 text-center">
                    <div class="text-sm font-semibold text-gray-400 leading-none">Score:</div>
                    <div class="text-lg font-bold text-white leading-tight" id="score-display">0</div>
                </div>
                
                
<div class="quiz-stat-box rounded-lg p-2 text-center">
                    <div class="text-sm font-semibold text-gray-400 leading-none">Time Remaining:</div>
                    <div class="text-lg font-bold text-white leading-tight" id="time-remaining-display">12s</div>
                </div>

                
<div class="quiz-stat-box rounded-lg p-2 text-center">
                    <div class="text-sm font-semibold text-gray-400 leading-none">Progress:</div>
                    <div class="text-lg font-bold text-white leading-tight" id="progress-display">1/6</div>
                </div>
            </div>

            
<div class="mb-8 p-4 rounded-xl bg-zinc-800/50">
                <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3 text-center" id="category-display-header">Question <span id="current-q-num">1</span>/<span id="total-q-count">6</span></p>
                <h2 class="text-xl font-bold leading-relaxed text-white text-center" id="question-text">Question text...</h2>
            </div>

            
<div id="choices-container" class="space-y-3">
                
</div>

            
<div id="feedback-message" class="mt-4 text-center text-sm font-bold h-6 text-yellow-300"></div>
        </div>


        
<div id="results-screen" class="hidden flex-col w-full items-center text-center">
            <h2 class="text-3xl font-black title-glow mb-1">Quiz Complete</h2>
            <p class="text-xl font-bold text-gray-300 mb-6" id="player-name-result">PLAYER</p>

            
<div id="screenshot-wrapper" class="hidden flex-col items-center justify-center w-full mb-8">
                <div id="results-card" class="w-full results-card p-6 sm:p-8 relative overflow-hidden">
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 bg-blue-500/20 blur-3xl rounded-full" id="blue-glow-circle"></div>
                    
                    <h3 class="text-2xl font-black uppercase tracking-wider text-center text-gradient-cyan-blue mb-4 relative z-10" id="results-title-gradient">
                        BILLIONS QUIZ RESULTS
                    </h3>
                    
                    <p class="text-lg font-bold text-white mb-2 relative z-10" id="player-name-result-card">PLAYER</p>
                    <p class="text-sm text-gray-400 uppercase tracking-wider mb-6 relative z-10" id="level-q-count-result">
                        EASY LEVEL • 6 QUESTIONS
                    </p>

                    <p class="text-6xl font-black text-gradient-cyan-blue mb-2 relative z-10" id="final-percentage">0%</p>
                    <p class="text-xl font-extrabold text-white uppercase tracking-wider mb-8 relative z-10" id="intuition-iq-message">NOVICE</p>
                    
                    <div class="grid grid-cols-3 gap-4 mb-8">
                        
<div class="result-stat-box rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-white" id="result-total-questions">6</div>
                            <div class="text-xs font-semibold text-gray-400 uppercase mt-1">QUESTIONS</div>
                        </div>
                        
<div class="result-stat-box rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-white" id="result-time-per-q">12s</div>
                            <div class="text-xs font-semibold text-gray-400 uppercase mt-1">TIME PER Q</div>
                        </div>
                        
<div class="result-stat-box rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-white" id="result-max-streak">2</div>
                            <div class="text-xs font-semibold text-gray-400 uppercase mt-1">MAX STREAK</div>
                        </div>
                    </div>

                    <p class="text-sm text-gray-300 leading-relaxed mb-6 relative z-10" id="result-message">
                        Your knowledge base needs to be solidified. Review the core concepts and try again!
                    </p>

                    <div class="text-xs text-gray-500 mb-2 relative z-10">Billions Quiz</div>
                    <div class="text-xs text-gray-500 relative z-10" id="result-date">November 27, 2025</div>
                </div>
            </div>

            <div class="w-full grid grid-cols-2 gap-3 mb-3 mt-8">
                <button onclick="showScreen('quiz-settings-screen')" class="w-full py-3 rounded-xl font-bold text-md bg-zinc-700 text-white hover:bg-zinc-600 transition-colors">
                    Try Again
                </button>
                <button onclick="downloadResults()" class="w-full py-3 rounded-xl font-bold text-md bg-gradient-to-r from-green-400 to-emerald-600 text-[#0a0a0a] hover:opacity-90 transition-opacity">
                    Download Results
                </button>
            </div>
            <div class="w-full grid grid-cols-2 gap-3 mb-6">
                <button onclick="shareOnX()" class="w-full py-3 rounded-xl font-bold text-md bg-blue-500 text-white hover:bg-blue-400 transition-colors">
                    Share on X
                </button>
                <button onclick="showScreen('quiz-settings-screen')" class="w-full py-3 rounded-xl font-bold text-md bg-gradient-to-r from-cyan-400 to-blue-600 text-white hover:opacity-90 transition-opacity">
                    View Leaderboard
                </button>
            </div>
        </div>
    </div>

    
<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, where, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // setLogLevel('Debug'); // Uncomment to debug Firebase

        // --- GLOBAL FUNCTION EXPORTS (Required for onclick in HTML) ---
        window.selectDifficulty = selectDifficulty;
        window.startGame = startGame;
        window.handleAnswer = handleAnswer; // Exposed for answer buttons
        window.showScreen = showScreen;
        window.downloadResults = downloadResults; 
        window.shareOnX = shareOnX; 
        window.filterLeaderboard = filterLeaderboard; // New function for filtering

        // --- QUIZ DATA (Structured by Difficulty) ---
        const QUIZ_DATA_BY_DIFFICULTY = {
            easy: [
                {
                    question: "What is the main goal of Billions Network?",
                    answerOptions: [
                        { text: "To create a single global social network", isCorrect: false },
                        { text: "To verify identities and prevent fake accounts", isCorrect: true },
                        { text: "To provide cryptocurrency trading", isCorrect: false }
                    ]
                },
                {
                    question: "Which of the following can Billions Network verify?",
                    answerOptions: [
                        { text: "Only humans", isCorrect: false },
                        { text: "Humans and AI agents", isCorrect: true },
                        { text: "Only businesses", isCorrect: false }
                    ]
                },
                {
                    question: "What information is required for human verification on Billions Network?",
                    answerOptions: [
                        { text: "A valid ID and device", isCorrect: true },
                        { text: "Only a social media account", isCorrect: false },
                        { text: "A signed notarized letter", isCorrect: false }
                    ]
                },
                {
                    question: "Does Billions Network sell your personal data to advertisers?",
                    answerOptions: [
                        { text: "Yes", isCorrect: false },
                        { text: "No", isCorrect: true },
                        { text: "Only for premium users", isCorrect: false }
                    ]
                },
                {
                    question: "How long does verification usually take on Billions Network?",
                    answerOptions: [
                        { text: "A few minutes", isCorrect: true },
                        { text: "Several days", isCorrect: false },
                        { text: "Weeks", isCorrect: false }
                    ]
                },
                {
                    question: "Can someone else verify an identity on your behalf?",
                    answerOptions: [
                        { text: "No", isCorrect: true },
                        { text: "Yes", isCorrect: false },
                        { text: "Only a family member", isCorrect: false }
                    ]
                },
            ],
            medium: [
                {
                    question: "How does Billions Network maintain privacy during verification?",
                    answerOptions: [
                        { text: "Encrypts data and does not store raw personal information", isCorrect: true },
                        { text: "Stores all data on a centralized server", isCorrect: false },
                        { text: "Shares your data with partner apps", isCorrect: false }
                    ]
                },
                {
                    question: "What problem does the “proof of uniqueness” solve?",
                    answerOptions: [
                        { text: "Prevents duplicate or fake identities", isCorrect: true },
                        { text: "Confirms your favorite apps", isCorrect: false },
                        { text: "Ensures your device is updated", isCorrect: false }
                    ]
                },
                {
                    question: "Why might apps and services want users verified by Billions Network?",
                    answerOptions: [
                        { text: "To reduce fake users and improve trust", isCorrect: true },
                        { text: "To access private emails", isCorrect: false },
                        { text: "To automatically give discounts", isCorrect: false }
                    ]
                },
                {
                    question: "Once verified, can your Billions identity be reused across different platforms?",
                    answerOptions: [
                        { text: "Yes", isCorrect: true },
                        { text: "No", isCorrect: false },
                        { text: "Only within the same country", isCorrect: false }
                    ]
                },
                {
                    question: "How is Billions Network different from social media verification?",
                    answerOptions: [
                        { text: "It uses cryptography and privacy-first verification", isCorrect: true },
                        { text: "It posts your ID publicly", isCorrect: false },
                        { text: "It only works with celebrity accounts", isCorrect: false }
                    ]
                },
                {
                    question: "What is one real-world impact of Billions Network verification?",
                    answerOptions: [
                        { text: "Reduces duplicate accounts and fraud", isCorrect: true },
                        { text: "Automatically increases your credit score", isCorrect: false },
                        { text: "Changes your social media ranking", isCorrect: false }
                    ]
                },
            ],
            hard: [
                {
                    question: "Who are the founders of Billions Network?",
                    answerOptions: [
                        { text: "Evan McMillan and David Shwartz", isCorrect: false },
                        { text: "Evein McMullen and David Schwartz", isCorrect: true },
                        { text: "Evan McMullen and Daniel Schwartz", isCorrect: false }
                    ]
                },
                {
                    question: "What is a key feature that allows Billions to resist fake AI-generated accounts?",
                    answerOptions: [
                        { text: "Liveness detection and ID checks", isCorrect: true },
                        { text: "Tracking IP addresses", isCorrect: false },
                        
                        { text: "Requiring a social media login", isCorrect: false } 
                    ]
                },
                {
                    question: "What is one potential benefit of Billions Network for AI agents?",
                    answerOptions: [
                        { text: "Allows AI to have verified digital identities", isCorrect: true },
                        { text: "Gives AI access to users’ private emails", isCorrect: false },
                        { text: "Lets AI post on social media automatically", isCorrect: false }
                    ]
                },
                {
                    question: "How does Billions Network ensure you remain in control of your data?",
                    answerOptions: [
                        { text: "By giving users cryptographic proofs instead of raw data", isCorrect: true },
                        { text: "By sending all data to a central authority", isCorrect: false },
                        { text: "By publishing your identity on a public ledger", isCorrect: false }
                    ]
                },
                {
                    question: "Which of the following BEST describes Billions Network’s approach?",
                    answerOptions: [
                        { text: "Privacy-first, decentralized verification", isCorrect: true },
                        { text: "Centralized data storage", isCorrect: false },
                        { text: "A simple login system for apps", isCorrect: false }
                    ]
                },
                {
                    question: "Why is “proof of uniqueness” important for preventing Sybil attacks?",
                    answerOptions: [
                        { text: "It ensures one person can only create one verified identity", isCorrect: true },
                        { text: "It blocks social media apps", isCorrect: false },
                        { text: "It checks your device model", isCorrect: false }
                    ]
                },
                {
                    question: "What is the main purpose of the $BILL token in Billions Network?",
                    answerOptions: [
                        { text: "To serve as a verification, staking, governance, and ecosystem reward token", isCorrect: true },
                        { text: "To act only as a social media reward", isCorrect: false },
                        { text: "To pay for streaming services", isCorrect: false }
                    ]
                },
                {
                    question: "If Billions becomes widely adopted, what is a potential societal effect?",
                    answerOptions: [
                        { text: "Safer and more trusted online interactions", isCorrect: true },
                        { text: "All websites become free", isCorrect: false },
                        { text: "Social media accounts become anonymous by default", isCorrect: false }
                    ]
                },
            ]
        };

        // --- QUIZ STATE MANAGEMENT ---
        let currentDifficulty = 'easy';
        let currentQuestions = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let maxStreak = 0;
        let currentStreak = 0;
        let quizTimerInterval = null;
        let questionTimeout = 0; 
        let timeLeft = 0;
        let isQuestionActive = false; 

        // --- FIREBASE SETUP ---
        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let isAuthReady = false;
        
        // Define the Firestore collection path for the public leaderboard
        const LEADERBOARD_COLLECTION_PATH = `artifacts/${appId}/public/data/leaderboard`;
        
        // State for Leaderboard Filtering (New)
        let currentLeaderboardFilter = 'easy'; // Default filter
        const LEADERBOARD_LIMIT = 100; // New limit

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Authentication
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Auth State Listener
                onAuthStateChanged(auth, (user) => {
                    userId = user ? user.uid : crypto.randomUUID();
                    isAuthReady = true;
                    console.log("Firebase Auth Initialized. User ID:", userId);
                    // Load the default leaderboard view after auth is ready
                    loadLeaderboard(currentLeaderboardFilter); 
                });
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                // Fallback for UI if Firebase fails to init
                isAuthReady = true; 
                loadLeaderboard(currentLeaderboardFilter);
            }
        }
        
        // --- QUIZ LOGIC ---

        function selectDifficulty(difficulty) {
            currentDifficulty = difficulty;
            document.querySelectorAll('.diff-btn').forEach(btn => {
                if (btn.id === `btn-diff-${difficulty}`) {
                    btn.classList.add('bg-active-gradient');
                    btn.classList.remove('bg-inactive');
                } else {
                    btn.classList.remove('bg-active-gradient');
                    btn.classList.add('bg-inactive');
                }
            });
            // Update leaderboard title on the settings screen
            document.getElementById('leaderboard-title-diff').textContent = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function startGame() {
            const userName = document.getElementById('user-name-input').value.trim();
            if (!userName || userName.length < 2) {
                document.getElementById('error-msg').textContent = "Please enter a valid name (min 2 characters).";
                return;
            }
            document.getElementById('error-msg').textContent = ""; 
            
            // Set initial state
            currentQuestions = [...QUIZ_DATA_BY_DIFFICULTY[currentDifficulty]];
            shuffleArray(currentQuestions);
            currentQuestionIndex = 0;
            score = 0;
            currentStreak = 0;
            maxStreak = 0;
            questionTimeout = getQuestionTime(currentDifficulty);
            
            // Update UI displays
            document.getElementById('player-name-display').textContent = userName.toUpperCase();
            document.getElementById('score-display').textContent = score;
            document.getElementById('total-q-count').textContent = currentQuestions.length;
            
            // Start the quiz flow
            showScreen('quiz-content');
            loadQuestion();
        }

        function getQuestionTime(difficulty) {
            switch(difficulty) {
                case 'easy': return 12;
                case 'medium': return 8;
                case 'hard': return 4;
                default: return 10;
            }
        }

        function loadQuestion() {
            if (currentQuestionIndex >= currentQuestions.length) {
                endQuiz();
                return;
            }

            const qData = currentQuestions[currentQuestionIndex];
            
            // Reset state for new question
            clearInterval(quizTimerInterval);
            timeLeft = questionTimeout;
            isQuestionActive = true;
            document.getElementById('feedback-message').textContent = "";
            
            // Update progress
            document.getElementById('progress-display').textContent = `${currentQuestionIndex + 1}/${currentQuestions.length}`;
            document.getElementById('current-q-num').textContent = currentQuestionIndex + 1;
            
            // Update question text
            document.getElementById('question-text').textContent = qData.question;
            
            // Render choices
            const choicesContainer = document.getElementById('choices-container');
            choicesContainer.innerHTML = '';
            shuffleArray(qData.answerOptions); // Shuffle answers for variation
            
            qData.answerOptions.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = 'answer-button w-full p-4 text-left rounded-xl text-lg font-semibold shadow-md transition-all duration-200';
                button.textContent = option.text;
                button.onclick = () => handleAnswer(option.isCorrect, button);
                button.setAttribute('data-is-correct', option.isCorrect);
                choicesContainer.appendChild(button);
            });
            
            // Start the timer
            startTimer();
        }

        function startTimer() {
            const timerBar = document.getElementById('timer-bar');
            const timeDisplay = document.getElementById('time-remaining-display');
            
            // Set initial bar width and smooth transition for the whole duration
            timerBar.style.width = '100%';
            timerBar.style.transition = `width ${timeLeft}s linear`;
            
            // Start the bar shrinking immediately
            requestAnimationFrame(() => {
                timerBar.style.width = '0%';
            });

            timeDisplay.textContent = `${timeLeft}s`;

            quizTimerInterval = setInterval(() => {
                timeLeft -= 1;
                if (timeLeft >= 0) {
                    timeDisplay.textContent = `${timeLeft}s`;
                } else {
                    // Time's up: treat as an incorrect answer
                    clearInterval(quizTimerInterval);
                    handleAnswer(false, null, true); // Pass true for isTimeout
                }
            }, 1000);
        }

        function handleAnswer(isCorrect, selectedButton, isTimeout = false) {
            if (!isQuestionActive) return; // Prevent multiple answers
            isQuestionActive = false;
            clearInterval(quizTimerInterval);
            
            // Stop the timer bar animation by setting transition to none, and width to current value
            const timerBar = document.getElementById('timer-bar');
            const currentWidth = timerBar.offsetWidth / timerBar.parentElement.offsetWidth * 100;
            timerBar.style.transition = 'none';
            timerBar.style.width = `${currentWidth}%`;

            const choices = document.querySelectorAll('#choices-container button');
            
            choices.forEach(btn => {
                btn.disabled = true; // Disable all buttons
                if (btn.getAttribute('data-is-correct') === 'true') {
                    // Highlight the correct answer
                    btn.classList.add('bg-green-600', 'text-white', 'shadow-lg');
                    btn.classList.remove('answer-button');
                } else if (btn === selectedButton) {
                    // Highlight the incorrect selection
                    btn.classList.add('bg-red-600', 'text-white', 'shadow-lg');
                    btn.classList.remove('answer-button');
                }
            });

            const feedback = document.getElementById('feedback-message');

            if (isCorrect) {
                score++;
                currentStreak++;
                maxStreak = Math.max(maxStreak, currentStreak);
                feedback.textContent = `Correct! Streak: ${currentStreak}`;
                feedback.classList.remove('text-red-500', 'text-yellow-300');
                feedback.classList.add('text-green-500');
                document.getElementById('score-display').textContent = score;
            } else {
                currentStreak = 0;
                if (isTimeout) {
                    feedback.textContent = "Time's Up! No point.";
                    feedback.classList.remove('text-green-500', 'text-red-500');
                    feedback.classList.add('text-yellow-300');
                } else {
                    feedback.textContent = "Incorrect. Streak lost.";
                    feedback.classList.remove('text-green-500', 'text-yellow-300');
                    feedback.classList.add('text-red-500');
                }
            }

            // Move to the next question after a brief delay
            setTimeout(() => {
                currentQuestionIndex++;
                loadQuestion();
            }, isTimeout ? 2000 : 1500); // Longer delay for timeout
        }

        function endQuiz() {
            showScreen('results-screen');
            
            // --- Calculate Results ---
            const totalQuestions = currentQuestions.length;
            const finalScore = score;
            const percentage = totalQuestions > 0 ? Math.round((finalScore / totalQuestions) * 100) : 0;
            const userName = document.getElementById('user-name-input').value.trim();
            const timePerQ = getQuestionTime(currentDifficulty);

            // --- Update Result Screen UI ---
            document.getElementById('player-name-result').textContent = userName;
            document.getElementById('player-name-result-card').textContent = userName;
            document.getElementById('level-q-count-result').textContent = 
                `${currentDifficulty.toUpperCase()} LEVEL • ${totalQuestions} QUESTIONS`;
            document.getElementById('final-percentage').textContent = `${percentage}%`;
            document.getElementById('result-total-questions').textContent = totalQuestions;
            document.getElementById('result-time-per-q').textContent = `${timePerQ}s`;
            document.getElementById('result-max-streak').textContent = maxStreak;
            document.getElementById('result-date').textContent = new Date().toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric'
            });

            // Intuition/IQ Message
            let message = "";
            let iqMessage = "";
            if (percentage === 100) {
                iqMessage = "MASTER BILLIONAIRE";
                message = "You have an impeccable understanding of Billions Network. True verification mastery!";
            } else if (percentage >= 80) {
                iqMessage = "VERIFIED ELITE";
                message = "Excellent knowledge! You are definitely ready to participate in the network.";
            } else if (percentage >= 60) {
                iqMessage = "SOLID INTUITION";
                message = "A strong performance. Just a little more focus will get you to the elite level.";
            } else if (percentage >= 40) {
                iqMessage = "LEARNING PHASE";
                message = "You have some foundational knowledge, but need to review the core concepts.";
            } else {
                iqMessage = "NOVICE";
                message = "Your knowledge base needs to be solidified. Review the core concepts and try again!";
            }
            document.getElementById('intuition-iq-message').textContent = iqMessage;
            document.getElementById('result-message').textContent = message;

            // Submit result to leaderboard
            submitLeaderboardScore(userName, finalScore, totalQuestions, currentDifficulty, maxStreak, percentage);
        }

        // --- FIREBASE LEADERBOARD FUNCTIONS ---

        // Submits the final score to Firestore
        async function submitLeaderboardScore(name, score, total, difficulty, streak, percentage) {
            if (!db || !isAuthReady) {
                console.error("Firebase not ready for score submission.");
                return;
            }

            try {
                // Generate a score ID using the user ID and timestamp to ensure uniqueness per session
                const docRef = doc(collection(db, LEADERBOARD_COLLECTION_PATH));

                const scoreData = {
                    name: name,
                    score: score,
                    total: total,
                    percentage: percentage, // Store percentage for easier display/sorting
                    difficulty: difficulty,
                    maxStreak: streak,
                    timestamp: serverTimestamp(),
                    userId: userId, // Link score to user
                };

                await setDoc(docRef, scoreData);
                console.log("Score submitted successfully with ID:", docRef.id);
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        }
        
        // Attaches a real-time listener to the leaderboard
        function loadLeaderboard(difficultyFilter) {
            if (!db || !isAuthReady) {
                document.getElementById('leaderboard-status').textContent = "Waiting for connection...";
                return;
            }
            
            document.getElementById('leaderboard-status').textContent = "Loading scores...";
            currentLeaderboardFilter = difficultyFilter;

            const q = query(
                collection(db, LEADERBOARD_COLLECTION_PATH),
                where("difficulty", "==", difficultyFilter),
                // IMPORTANT: We do NOT use orderBy() here to avoid mandatory index creation.
                limit(LEADERBOARD_LIMIT) 
            );

            // Filter button active state management
            document.querySelectorAll('.leaderboard-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-filter') === difficultyFilter);
            });
            document.getElementById('leaderboard-title-diff').textContent = difficultyFilter.charAt(0).toUpperCase() + difficultyFilter.slice(1);
            
            // Set up real-time listener
            onSnapshot(q, (snapshot) => {
                let scores = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                }));
                
                // Client-side sorting is mandatory to avoid index errors with orderBy
                scores.sort((a, b) => {
                    if (a.percentage !== b.percentage) {
                        return b.percentage - a.percentage; // Primary: Higher percentage first
                    }
                    if (a.score !== b.score) {
                         return b.score - a.score; // Secondary: Higher score first
                    }
                    // Tertiary: Earlier time first (for tie-breaking on similar scores)
                    const timeA = a.timestamp?.seconds || 0;
                    const timeB = b.timestamp?.seconds || 0;
                    return timeA - timeB; 
                });

                renderLeaderboard(scores);

            }, (error) => {
                console.error("Error fetching leaderboard:", error);
                document.getElementById('leaderboard-status').textContent = "Failed to load scores.";
            });
        }
        
        // Function to be called from HTML onclick
        function filterLeaderboard(difficulty) {
             // Simply call loadLeaderboard with the new filter
             loadLeaderboard(difficulty);
        }


        function renderLeaderboard(scores) {
            const list = document.getElementById('leaderboard-list');
            const status = document.getElementById('leaderboard-status');
            list.innerHTML = '';
            
            if (scores.length === 0) {
                status.textContent = `No scores recorded for ${currentLeaderboardFilter.toUpperCase()} yet.`;
                status.classList.remove('hidden');
                return;
            }
            
            status.classList.add('hidden'); // Hide status message if scores exist

            scores.slice(0, 10).forEach((scoreEntry, index) => { // Show top 10
                const isCurrentUser = scoreEntry.userId === userId;
                
                const listItem = document.createElement('li');
                listItem.className = `flex justify-between items-center p-3 rounded-lg shadow-md transition-all duration-200 ${
                    isCurrentUser 
                        ? 'bg-blue-600 border border-cyan-400 text-white transform scale-[1.02]' 
                        : 'bg-zinc-800 border border-zinc-700 text-gray-200'
                }`;
                
                const rank = index + 1;
                const rankClass = rank === 1 ? 'text-2xl font-black text-cyan-400' :
                                 rank === 2 ? 'text-xl font-bold text-cyan-500' :
                                 rank === 3 ? 'text-lg font-semibold text-cyan-600' :
                                 'text-base font-semibold text-gray-400';

                listItem.innerHTML = `
                    <span class="${rankClass} w-8 text-left">${rank}.</span>
                    <span class="flex-1 font-bold text-left truncate mx-2">${scoreEntry.name}</span>
                    <span class="font-bold text-lg ${isCurrentUser ? 'text-yellow-300' : 'text-cyan-400'}">${scoreEntry.percentage}%</span>
                `;
                list.appendChild(listItem);
            });
        }

        // --- SCREEN AND VISUAL UTILITIES ---

        function showScreen(screenId) {
            ['quiz-settings-screen', 'quiz-content', 'results-screen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
                document.getElementById(id).classList.remove('flex-col');
            });
            document.getElementById(screenId).classList.remove('hidden');
            document.getElementById(screenId).classList.add('flex-col');

            // Special handling for screenshot wrapper visibility on results screen
            if (screenId === 'results-screen') {
                document.getElementById('screenshot-wrapper').classList.remove('hidden');
                document.getElementById('screenshot-wrapper').classList.add('flex-col');
            } else {
                document.getElementById('screenshot-wrapper').classList.add('hidden');
                document.getElementById('screenshot-wrapper').classList.remove('flex-col');
            }
        }
        
        // --- SCREENSHOT & SHARE UTILITIES ---

        async function downloadResults() {
            const resultsCard = document.getElementById('results-card');
            const screenshotWrapper = document.getElementById('screenshot-wrapper');

            // 1. Prepare for screenshot: Apply temporary classes for background and gradient fixes
            screenshotWrapper.classList.add('screenshot-wrapper-padded');
            resultsCard.classList.add('screenshot-container-padding');

            // Temporarily replace gradients with solid colors for text/percentage for better canvas capture
            const resultsTitle = document.getElementById('results-title-gradient');
            const finalPercentage = document.getElementById('final-percentage');
            const blueGlowCircle = document.getElementById('blue-glow-circle');

            resultsTitle.classList.add('h2c-text-gradient-fix');
            finalPercentage.classList.add('h2c-percentage-gradient-fix');
            blueGlowCircle.classList.add('h2c-blue-glow-fix');


            // 2. Capture the card using html2canvas
            const canvas = await html2canvas(resultsCard, {
                // Ensure the full background is rendered correctly
                backgroundColor: resultsCard.style.backgroundColor, 
                // Set scale higher for better resolution
                scale: 3, 
                // Use a proper image type
                type: 'dataURL',
                allowTaint: true,
                useCORS: true, 
            });

            // 3. Cleanup: Remove temporary classes
            resultsTitle.classList.remove('h2c-text-gradient-fix');
            finalPercentage.classList.remove('h2c-percentage-gradient-fix');
            blueGlowCircle.classList.remove('h2c-blue-glow-fix');
            screenshotWrapper.classList.remove('screenshot-wrapper-padded');
            resultsCard.classList.remove('screenshot-container-padding');

            // 4. Download the image
            const imageURL = canvas.toDataURL("image/png");
            const userName = document.getElementById('user-name-input').value.trim().replace(/\s/g, '_');
            const date = new Date().toISOString().split('T')[0];
            const link = document.createElement('a');
            link.href = imageURL;
            link.download = `Billions_Quiz_Result_${userName}_${date}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function shareOnX() {
            const userName = document.getElementById('user-name-input').value.trim();
            const percentage = document.getElementById('final-percentage').textContent;
            const iqMessage = document.getElementById('intuition-iq-message').textContent;
            const difficulty = currentDifficulty.toUpperCase();
            
            const text = encodeURIComponent(
                `I just took the Billions Network Identity Quiz (${difficulty} Level) and scored a ${percentage} (${iqMessage})! 🚀 \n\nCheck your knowledge on identity verification and AI agents! #BillionsNetwork #VerifiedIdentity`
            );
            
            const url = `https://twitter.com/intent/tweet?text=${text}`;
            window.open(url, '_blank');
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            initFirebase();
            selectDifficulty(currentDifficulty); // Initialize button state
            showScreen('quiz-settings-screen');
        };
    </script>
